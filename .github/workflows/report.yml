name: Relatório de Commits

on:
  pull_request:
    types: [closed]

jobs:
  commit_report:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
      - name: Check out repository
        uses: actions/checkout@v2

      - name: Fetch all commits
        run: git fetch --prune --unshallow

      - name: Gerar relatório de commits em XML
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          HEAD_SHA: ${{ github.sha }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          REPORT_PATH="commit_report.xml"
          echo "<?xml version='1.0' encoding='UTF-8'?>" > $REPORT_PATH
          echo "<commitReport>" >> $REPORT_PATH
          echo "  <pullRequest>" >> $REPORT_PATH
          echo "    <number>${PR_NUMBER}</number>" >> $REPORT_PATH
          echo "    <description>Relatório de Commits para PR #${PR_NUMBER}</description>" >> $REPORT_PATH
          echo "  </pullRequest>" >> $REPORT_PATH

          echo "  <commits>" >> $REPORT_PATH
          git log $BASE_SHA..$HEAD_SHA --oneline --pretty=format:"<commit><hash>%h</hash><author>%an</author><date>%ar</date><message>%s</message></commit>" >> $REPORT_PATH
          echo "  </commits>" >> $REPORT_PATH

          echo "  <detailedChanges>" >> $REPORT_PATH
          git log $BASE_SHA..$HEAD_SHA --oneline --pretty=format:"%h" | while read commit_hash; do
            COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s" $commit_hash)
            echo "    <commit>" >> $REPORT_PATH
            echo "      <hash>$commit_hash</hash>" >> $REPORT_PATH
            echo "      <message>$COMMIT_MESSAGE</message>" >> $REPORT_PATH
            echo "      <diff>" >> $REPORT_PATH
            git show $commit_hash --patch | tail -n +2 | sed 's/&/&amp;/g; s/</&lt;/g; s/>/&gt;/g' >> $REPORT_PATH
            echo "      </diff>" >> $REPORT_PATH
            echo "    </commit>" >> $REPORT_PATH
          done
          echo "  </detailedChanges>" >> $REPORT_PATH

          echo "</commitReport>" >> $REPORT_PATH

      - name: Upload XML commit report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: commit-report-xml
          path: commit_report.xml

      - name: Publicar comentário com link de download
        uses: actions/github-script@v6
        env:
          GITHUB_TOKEN: ${{ secrets.PAT_TOKEN }}
        with:
          github-token: ${{ secrets.PAT_TOKEN }}
          script: |
            const prNumber = ${{ github.event.pull_request.number }};
            const repoUrl = `https://github.com/${{ github.repository }}`;
            const artifactUrl = `${repoUrl}/actions/runs/${{ github.run_id }}`;
            const commentBody = `
              ### 📄 Relatório de Commits para PR #${prNumber}

              Você pode baixar o relatório detalhado em XML [aqui](${artifactUrl}).
            `;
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: prNumber,
              body: commentBody,
            });