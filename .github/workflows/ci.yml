name: CI with Coverage

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'

    - name: Install dependencies
      run: npm install

    - name: Run tests and generate coverage report
      run: npm run test -- --coverage --coverageReporters=text-summary
      continue-on-error: true
      id: test

    - name: Check coverage
      run: |
        COVERAGE=$(grep -Po 'All files.*? \K\d+(?=%)' coverage/coverage-summary.txt)
        if [ "$COVERAGE" -lt 60 ]; then
          echo "Coverage is below 60%"
          exit 1
        fi
      continue-on-error: true
      id: coverage

    - name: Comment on PR
      if: failure()
      uses: actions/github-script@v6
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const { GITHUB_SHA, GITHUB_REPOSITORY, GITHUB_EVENT_NAME, GITHUB_REF } = process.env;
          const { context } = require('@actions/github');

          const coverage = require('fs').readFileSync('coverage/coverage-summary.txt', 'utf8').match(/All files.*? (\d+(.\d+)?%)/)[1];

          const commentBody = `
            ## Test Coverage Report
            **Coverage:** ${coverage}
            **Result:** Coverage is below the required threshold of 60%.
          `;

          if (GITHUB_EVENT_NAME === 'pull_request') {
            const { repo, issue } = context;
            const issue_number = issue.number;
            await github.rest.issues.createComment({
              ...repo,
              issue_number,
              body: commentBody,
            });
          }