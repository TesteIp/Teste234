name: Run PHPUnit with Coverage

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # Checkout do código
      - name: Checkout code
        uses: actions/checkout@v3

      # Configuração do PHP
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: xdebug

      # Instalação das dependências do Composer
      - name: Install dependencies
        run: |
          composer install

      # Executa os testes PHPUnit
      - name: Run PHPUnit tests with coverage
        run: |
          vendor/bin/phpunit --coverage-clover=coverage.xml --log-junit=junit.xml

      # Verifica cobertura e posta comentário
      - name: Post Coverage Result
        if: always()  # Garante que o comentário será postado, mesmo com falha
        run: |
          # Calcula a cobertura de código
          COVERAGE=$(php -r "
              libxml_use_internal_errors(true);
              \$xml = simplexml_load_file('coverage.xml');
              if (\$xml === false) {
                  echo 'Erro ao carregar o arquivo coverage.xml';
                  exit(1);
              }
              // Calcula a cobertura como (coveredelements / elements) * 100
              \$coverage = (\$xml->project->metrics['coveredelements'] / \$xml->project->metrics['elements']) * 100;
              echo \$coverage;
          ")

          # Garante que o código será barrado se a cobertura for menor que 60%
          if (( $(echo "$COVERAGE < 60" | bc -l) )); then
            echo "Cobertura abaixo de 60%, barrando execução!";
            exit 1;
          fi

          # Extração de dados do JUnit para comentários
          TESTS=$(grep -o 'tests="[^"]*' junit.xml | head -n 1 | sed 's/tests="//')
          FAILURES=$(grep -o 'failures="[^"]*' junit.xml | head -n 1 | sed 's/failures="//')
          SKIPPED=$(grep -o 'skipped="[^"]*' junit.xml | head -n 1 | sed 's/skipped="//')
          EXECUTION_TIME=$(grep -o 'time="[^"]*' junit.xml | head -n 1 | sed 's/time="//')

          # Criação do comentário
          COMMENT="### PHPUnit Test Coverage Report 🚀
          - **Total Coverage:** \$COVERAGE%
          - **Total Tests:** \$TESTS
          - **Failures:** \$FAILURES
          - **Skipped:** \$SKIPPED
          - **Execution Time:** \$EXECUTION_TIME seconds
          
          "

          # Postar o comentário no PR
          curl -H "Authorization: token ${{ secrets.PAT_TOKEN }}" -X POST \
            -d "{\"body\": \"$COMMENT\"}" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments"
