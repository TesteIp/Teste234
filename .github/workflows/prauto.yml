name: Auto Merge Back to Dev

on:
  pull_request:
    types: [closed]
    branches:
      - master

jobs:
  auto-merge:
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'hotfix/')
    name: Auto Merge Master to Dev
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout the repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  

    - name: Set up Git
      run: |
        git config --global user.name "joaovictor-ip4y"
        git config --global user.email "joao.victor@ip4y.com.br"

    - name: Fetch all branches
      run: git fetch origin

    - name: Merge master into dev
      run: |
        git checkout dev
        git merge master --allow-unrelated-histories

    - name: Push changes to a new branch
      run: |
        git checkout -b merge-master-into-dev
        git push origin merge-master-into-dev
      env:
        GITHUB_TOKEN: ${{ secrets.TESTE }}

    - name: Create Pull Request
      id: create_pr
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.TESTE }}
        commit-message: 'Auto merge master into dev'
        branch: merge-master-into-dev
        base: dev
        title: 'Auto Merge master into dev'
        body: 'This pull request was automatically created to merge changes from master into dev.'

    - name: Approve Pull Request
      run: |
        PR_NUMBER=$(jq -r '.pull_request.number' < $GITHUB_EVENT_PATH)
        curl -s -X POST -H "Authorization: token ${{ secrets.TESTE }}" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews" \
        -d '{"event":"APPROVE"}'
      env:
        GITHUB_TOKEN: ${{ secrets.TESTE }}